<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MCQ Exam System{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1000;
        }
        .question-card {
            margin-bottom: 20px;
        }
        .choice-option {
            margin: 10px 0;
        }
        
        /* Current time display styling */
        #current-time {
            color: rgba(255, 255, 255, 0.9) !important;
            font-size: 0.9rem;
            text-align: center;
            min-width: 120px;
        }
        
        .time-text {
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        .date-text {
            opacity: 0.8;
            font-size: 0.75rem;
        }
        
        @media (max-width: 768px) {
            #current-time {
                display: none;
            }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{% url 'exams:home' %}">
                <i class="fas fa-graduation-cap"></i> MCQ Exam System
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'exams:dashboard' %}">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        {% if user.is_examiner or user.is_admin %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'exams:create_exam' %}">
                                    <i class="fas fa-plus"></i> Create Exam
                                </a>
                            </li>
                        {% endif %}
                        {% if user.is_examinee or user.is_admin %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'exams:join_exam' %}">
                                    <i class="fas fa-sign-in-alt"></i> Join Exam
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'exams:exam_history' %}">
                                    <i class="fas fa-history"></i> Exam History
                                </a>
                            </li>
                        {% endif %}
                    {% endif %}
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <span class="nav-link" id="current-time">
                            <i class="fas fa-clock me-1"></i>
                            <span id="time-display">Loading...</span>
                        </span>
                    </li>
                    {% if user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user"></i> {{ user.username }}
                                <span class="badge bg-secondary ms-1">{{ user.get_role_display }}</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal" onclick="prepareLogout()">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'account_login' %}">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'account_signup' %}">
                                <i class="fas fa-user-plus"></i> Sign Up
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <!-- Logout Confirmation Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);">
                <div class="modal-header" style="border-bottom: none; padding: 30px 30px 0 30px;">
                    <div class="text-center w-100">
                        <div class="d-inline-flex align-items-center justify-content-center" 
                             style="width: 60px; height: 60px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border-radius: 50%; margin-bottom: 20px;">
                            <i class="fas fa-sign-out-alt text-white" style="font-size: 24px;"></i>
                        </div>
                        <h5 class="modal-title fw-bold" id="logoutModalLabel">Sign Out</h5>
                        <p class="text-muted mt-2">Are you sure you want to sign out?</p>
                    </div>
                </div>
                <div class="modal-body" style="padding: 20px 30px;">
                    <div class="alert alert-warning" style="border-radius: 12px; border: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> If you're in the middle of an exam, it will be automatically submitted.
                    </div>
                    <div class="text-center">
                        <p class="mb-3">You are currently signed in as <strong>{{ user.username }}</strong></p>
                        <p class="text-muted small">Role: <span class="badge bg-primary">{{ user.get_role_display }}</span></p>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: none; padding: 0 30px 30px 30px;">
                    <div class="d-flex justify-content-center gap-3 w-100">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 12px; padding: 10px 25px;">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <a href="{% url 'accounts:logout' %}" class="btn btn-danger" style="border-radius: 12px; padding: 10px 25px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border: none;" onclick="confirmLogout()">
                            <i class="fas fa-sign-out-alt me-2"></i>Sign Out
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Server time offset (in milliseconds)
        let serverTimeOffset = 0;
        
        // Get server time on page load
        function syncServerTime() {
            const clientTime = new Date().getTime();
            // We'll set this offset when we have server time
            serverTimeOffset = 0; // Will be updated by individual pages if needed
        }
        
        // Update current time every second
        function updateCurrentTime() {
            const now = new Date(new Date().getTime() + serverTimeOffset);
            const timeString = now.toLocaleTimeString('en-US', {
                hour12: true,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
            
            const timeDisplay = document.getElementById('time-display');
            if (timeDisplay) {
                timeDisplay.innerHTML = 
                    `<span class="time-text">${timeString}</span><br><small class="date-text">${dateString}</small>`;
            }
        }
        
        // Initialize time sync and start updating
        syncServerTime();
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        // Logout handling functions
        window.isLoggingOut = false;
        window.hasUnsavedWork = false;
        
        function prepareLogout() {
            window.isLoggingOut = true;
        }
        
        function confirmLogout() {
            window.isLoggingOut = true;
        }
        
        function handleBeforeUnload(e) {
            // Only show warning if there's actually unsaved work and user is not logging out
            if (!window.isLoggingOut && window.hasUnsavedWork) {
                e.preventDefault();
                e.returnValue = 'You have unsaved work. Are you sure you want to leave?';
            }
        }
        
        // Add beforeunload listener
        window.addEventListener('beforeunload', handleBeforeUnload);
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
