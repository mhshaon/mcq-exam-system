{% extends 'base.html' %}

{% block title %}{{ exam.title }} - Exam Pending{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .pending-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 50px 40px;
        width: 100%;
        max-width: 600px;
        margin: 20px auto;
        text-align: center;
    }
    
    .pending-header {
        margin-bottom: 30px;
    }
    
    .pending-header h2 {
        color: #333;
        font-weight: 700;
        margin-bottom: 15px;
    }
    
    .pending-header p {
        color: #666;
        font-size: 16px;
        line-height: 1.6;
    }
    
    .icon-wrapper {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        border-radius: 50%;
        margin-bottom: 30px;
        animation: pulse 2s infinite;
    }
    
    .icon-wrapper i {
        font-size: 32px;
        color: white;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .countdown-container {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin: 30px 0;
        border: 2px solid #e9ecef;
    }
    
    .countdown-timer {
        font-size: 3rem;
        font-weight: bold;
        color: #667eea;
        font-family: 'Courier New', monospace;
        margin-bottom: 15px;
    }
    
    .countdown-label {
        color: #666;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .exam-info {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin: 25px 0;
        text-align: left;
        border-left: 4px solid #667eea;
    }
    
    .exam-info h5 {
        color: #333;
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: #555;
    }
    
    .info-value {
        color: #333;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        padding: 12px 30px;
        font-weight: 600;
        font-size: 16px;
        color: white;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        margin: 10px;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        border: none;
        border-radius: 12px;
        padding: 12px 30px;
        font-weight: 600;
        font-size: 16px;
        color: white;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        margin: 10px;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
        color: white;
    }
    
    .status-badge {
        display: inline-block;
        padding: 8px 16px;
        background: #ffc107;
        color: #000;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 20px;
    }
    
    .instructions {
        background: #e3f2fd;
        border-radius: 12px;
        padding: 20px;
        margin: 25px 0;
        border-left: 4px solid #2196f3;
    }
    
    .instructions h6 {
        color: #1976d2;
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    .instructions ul {
        margin: 0;
        padding-left: 20px;
        color: #555;
    }
    
    .instructions li {
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="pending-container">
    <div class="pending-header">
        <div class="icon-wrapper">
            <i class="fas fa-clock"></i>
        </div>
        <h2>Exam Not Started Yet</h2>
        <p>The exam you're trying to join has not started yet.</p>
    </div>
    
    <div class="status-badge">
        <i class="fas fa-hourglass-half me-2"></i>Waiting for Exam to Start
    </div>
    
    <div class="countdown-container">
        <div class="countdown-timer" id="countdown-timer">Loading...</div>
        <div class="countdown-label">Time until exam starts</div>
    </div>
    
    <div class="exam-info">
        <h5><i class="fas fa-info-circle me-2"></i>Exam Information</h5>
        
        <div class="info-item">
            <span class="info-label">Exam Title:</span>
            <span class="info-value">{{ exam.title }}</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Exam Code:</span>
            <span class="info-value"><code>{{ exam.code }}</code></span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Start Time:</span>
            <span class="info-value">{{ exam.start_time|date:"F d, Y \a\t g:i A" }}</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Current Time:</span>
            <span class="info-value" id="current-time-display">{{ current_time|date:"F d, Y \a\t g:i A" }}</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Time Until Start:</span>
            <span class="info-value" id="time-until-start">Calculating...</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Duration:</span>
            <span class="info-value">{{ exam.duration_minutes }} minutes</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Questions:</span>
            <span class="info-value">{{ exam.num_questions }} questions</span>
        </div>
        
        {% if exam.description %}
        <div class="info-item">
            <span class="info-label">Description:</span>
            <span class="info-value">{{ exam.description }}</span>
        </div>
        {% endif %}
    </div>
    
    <div class="instructions">
        <h6><i class="fas fa-lightbulb me-2"></i>What to do next:</h6>
        <ul>
            <li>Wait for the exam to start at the scheduled time</li>
            <li>Make sure you have a stable internet connection</li>
            <li>Close any unnecessary applications or browser tabs</li>
            <li>This page will automatically refresh when the exam starts</li>
        </ul>
    </div>
    
    <div class="mt-4">
        <a href="{% url 'exams:join_exam' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Join Exam
        </a>
        <a href="{% url 'exams:dashboard' %}" class="btn btn-primary">
            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startTime = new Date('{{ start_time_iso }}');
    const countdownElement = document.getElementById('countdown-timer');
    const currentTimeDisplay = document.getElementById('current-time-display');
    const timeUntilStartDisplay = document.getElementById('time-until-start');
    
    // Debug information
    console.log('Server start time (ISO):', '{{ start_time_iso }}');
    console.log('Parsed start time:', startTime);
    console.log('Start time local:', startTime.toLocaleString());
    console.log('Current browser time:', new Date().toLocaleString());
    
    function updateCountdown() {
        const now = new Date();
        const timeDiff = startTime - now;
        
        // Update current time display
        if (currentTimeDisplay) {
            currentTimeDisplay.textContent = now.toLocaleString();
        }
        
        if (timeDiff <= 0) {
            // Exam has started, redirect to take exam
            countdownElement.innerHTML = '00:00:00';
            setTimeout(function() {
                window.location.href = '{% url "exams:take_exam" exam.code %}';
            }, 1000);
            return;
        }
        
        const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
        
        let timeString = '';
        if (days > 0) {
            timeString = `${days}d ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        } else {
            timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        countdownElement.innerHTML = timeString;
        
        // Update time until start display
        if (timeUntilStartDisplay) {
            timeUntilStartDisplay.textContent = timeString;
        }
        
        // Change color based on time remaining
        if (timeDiff <= 300000) { // 5 minutes
            countdownElement.style.color = '#dc3545';
        } else if (timeDiff <= 900000) { // 15 minutes
            countdownElement.style.color = '#ffc107';
        } else {
            countdownElement.style.color = '#667eea';
        }
    }
    
    // Update countdown immediately and then every second
    updateCountdown();
    setInterval(updateCountdown, 1000);
    
    // Auto-refresh page every 30 seconds to check for exam start
    setTimeout(function() {
        location.reload();
    }, 30000);
});
</script>
{% endblock %}
